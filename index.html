<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Master Formulaci√≥n - Estilo Educa3d</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        // Paleta inspirada en portales educativos
                        primary: "#2563eb",      // Azul Real
                        primary_dark: "#1e40af", 
                        secondary: "#10b981",    // Esmeralda
                        accent: "#f59e0b",       // √Åmbar
                        background: "#1e293b",   // Slate Dark (Fondo de la app)
                        surface: "#ffffff",      // Blanco (Tarjeta)
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'], // Fuente m√°s redondeada y amigable
                    },
                    boxShadow: {
                        'game': '0 4px 0 0 rgba(0, 0, 0, 0.2)', // Sombra s√≥lida para efecto 3D
                        'game-hover': '0 2px 0 0 rgba(0, 0, 0, 0.2)',
                    }
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        sub { vertical-align: sub; font-size: 0.75em; }
        
        /* Efecto de patr√≥n sutil en el fondo */
        .bg-pattern {
            background-color: #1e293b;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Botones estilo "Game" */
        .btn-game {
            transition: all 0.1s;
        }
        .btn-game:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 0 rgba(0,0,0,0.2) !important;
        }
    </style>
</head>
<body class="bg-pattern min-h-screen flex flex-col items-center justify-center p-4 font-sans text-slate-800">

    <main class="w-full max-w-lg bg-surface rounded-3xl shadow-2xl overflow-hidden border-4 border-slate-700/50">
        
        <header class="bg-primary text-white p-5 text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-white/10 opacity-20 transform -skew-y-6 scale-150 origin-bottom-left"></div>
            <div class="relative z-10 flex flex-col items-center">
                <div class="bg-white/20 p-2 rounded-full mb-2 backdrop-blur-sm shadow-sm">
                    <span class="material-icons-round text-3xl">science</span>
                </div>
                <h1 class="text-2xl font-extrabold tracking-tight">Formulaci√≥n Binaria</h1>
                <p class="text-blue-100 text-sm font-semibold opacity-90">Entrenamiento Interactivo</p>
            </div>
        </header>

        <div class="p-6 space-y-6">
            
            <div class="flex justify-between items-center border-b border-gray-100 pb-4">
                <div class="flex items-center space-x-2 text-gray-500">
                    <span class="material-icons-round text-primary">category</span>
                    <select id="category-filter" class="form-select text-sm font-bold border-none bg-blue-50 text-blue-800 rounded-lg focus:ring-2 focus:ring-primary cursor-pointer py-1 pl-2 pr-8">
                        <option value="all">Todo</option>
                        <option value="hidruros">Hidruros</option>
                        <option value="oxidos">√ìxidos</option>
                        <option value="peroxidos">Per√≥xidos</option>
                        <option value="sales">Sales</option>
                    </select>
                </div>
                <span id="question-type" class="text-xs font-black px-3 py-1 bg-gray-100 text-gray-600 rounded-full uppercase tracking-wider">
                    Cargando...
                </span>
            </div>

            <div class="bg-blue-50 rounded-2xl p-6 text-center border-2 border-blue-100 shadow-inner">
                <div id="challenge" class="text-xl font-bold text-slate-800 leading-snug">
                    </div>
            </div>

            <div id="input-area" class="space-y-4">
                
                <div id="container-stock" class="hidden">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Stock</label>
                    <input class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 text-lg font-semibold focus:border-primary focus:ring-0 focus:bg-white transition-colors" 
                           id="answer-stock" type="text" placeholder="Ej: √ìxido de hierro (III)"/>
                </div>

                <div id="container-sistem" class="hidden">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Sistem√°tica</label>
                    <input class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 text-lg font-semibold focus:border-primary focus:ring-0 focus:bg-white transition-colors" 
                           id="answer-sistem" type="text" placeholder="Ej: Tri√≥xido de dihierro"/>
                </div>

                <div id="container-formula" class="hidden">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">F√≥rmula</label>
                    <input class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 text-lg font-semibold focus:border-primary focus:ring-0 focus:bg-white transition-colors text-center tracking-wider" 
                           id="answer-formula" type="text" placeholder="Ej: Fe2O3"/>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <button id="hint-button" class="btn-game flex items-center justify-center w-full px-4 py-3 bg-amber-400 hover:bg-amber-500 text-white font-bold rounded-xl shadow-game border-b-4 border-amber-600 focus:outline-none" type="button">
                    <span class="material-icons-round mr-1">lightbulb</span> Pista
                </button>
                <button id="check-button" class="btn-game flex items-center justify-center w-full px-4 py-3 bg-secondary hover:bg-emerald-500 text-white font-bold rounded-xl shadow-game border-b-4 border-emerald-700 focus:outline-none" type="button">
                    <span class="material-icons-round mr-1">check_circle</span> Comprobar
                </button>
            </div>
            
            <button id="next-button" class="btn-game w-full px-4 py-3 bg-primary hover:bg-primary_dark text-white font-bold rounded-xl shadow-game border-b-4 border-blue-800 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed hidden" type="button" disabled>
                Siguiente Ejercicio <span class="material-icons-round ml-1 text-sm align-middle">arrow_forward</span>
            </button>

            <div id="feedback" class="hidden rounded-xl p-4 text-center font-bold text-sm fade-in border-2"></div>

            <div class="bg-slate-100 rounded-xl p-4 flex justify-around items-center border border-slate-200">
                <div class="text-center">
                    <div class="text-xs font-bold text-gray-400 uppercase">Aciertos</div>
                    <div class="text-2xl font-black text-secondary" id="correct-count">0</div>
                </div>
                <div class="w-px h-8 bg-gray-300"></div>
                <div class="text-center">
                    <div class="text-xs font-bold text-gray-400 uppercase">Fallos</div>
                    <div class="text-2xl font-black text-red-500" id="wrong-count">0</div>
                </div>
                <div class="w-px h-8 bg-gray-300"></div>
                <div class="text-center">
                    <div class="text-xs font-bold text-gray-400 uppercase">Total</div>
                    <div class="text-2xl font-black text-primary" id="total-count">0</div>
                </div>
            </div>

            <div id="error-history" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-red-400 uppercase">Repaso de Errores</h3>
                    <button id="clear-history" class="text-xs text-gray-400 hover:text-red-500 flex items-center"><span class="material-icons-round text-sm mr-1">delete</span>Borrar</button>
                </div>
                <div id="error-list" class="space-y-2 max-h-32 overflow-y-auto pr-1"></div>
            </div>

            <div id="stats-container" class="space-y-1 pt-2 border-t border-gray-100">
                </div>

        </div>

        <footer class="bg-gray-50 py-3 text-center border-t border-gray-200">
            <button id="reset-stats" class="text-xs font-bold text-gray-400 hover:text-red-400 transition-colors">
                Reiniciar Progreso
            </button>
        </footer>

    </main>

    <script>
        // --- BASE DE DATOS (Mismo contenido, sin cambios l√≥gicos) ---
        const compounds = [
            // HIDRUROS
            { f: "LiH", s: "Hidruro de litio", i: "Monohidruro de litio", cat: "hidruros" },
            { f: "NaH", s: "Hidruro de sodio", i: "Monohidruro de sodio", cat: "hidruros" },
            { f: "KH", s: "Hidruro de potasio", i: "Monohidruro de potasio", cat: "hidruros" },
            { f: "CaH2", s: "Hidruro de calcio", i: "Dihidruro de calcio", cat: "hidruros" },
            { f: "FeH2", s: "Hidruro de hierro (II)", i: "Dihidruro de hierro", cat: "hidruros" },
            { f: "FeH3", s: "Hidruro de hierro (III)", i: "Trihidruro de hierro", cat: "hidruros" },
            { f: "AlH3", s: "Hidruro de aluminio", i: "Trihidruro de aluminio", cat: "hidruros" },
            { f: "HCl", s: "Cloruro de hidr√≥geno", i: "Cloruro de hidr√≥geno", cat: "hidruros" },
            { f: "HBr", s: "Bromuro de hidr√≥geno", i: "Bromuro de hidr√≥geno", cat: "hidruros" },
            { f: "H2S", s: "Sulfuro de hidr√≥geno", i: "Sulfuro de hidr√≥geno", cat: "hidruros" },
            { f: "NH3", s: "(Amoniaco)", i: "Trihidruro de nitr√≥geno", cat: "hidruros" },
            { f: "CH4", s: "(Metano)", i: "Tetrahidruro de carbono", cat: "hidruros" },

            // √ìXIDOS
            { f: "Li2O", s: "√ìxido de litio", i: "Mon√≥xido de dilitio", cat: "oxidos" },
            { f: "Na2O", s: "√ìxido de sodio", i: "Mon√≥xido de disodio", cat: "oxidos" },
            { f: "K2O", s: "√ìxido de potasio", i: "Mon√≥xido de dipotasio", cat: "oxidos" },
            { f: "CaO", s: "√ìxido de calcio", i: "Mon√≥xido de calcio", cat: "oxidos" },
            { f: "MgO", s: "√ìxido de magnesio", i: "Mon√≥xido de magnesio", cat: "oxidos" },
            { f: "Al2O3", s: "√ìxido de aluminio", i: "Tri√≥xido de dialuminio", cat: "oxidos" },
            { f: "FeO", s: "√ìxido de hierro (II)", i: "Mon√≥xido de hierro", cat: "oxidos" },
            { f: "Fe2O3", s: "√ìxido de hierro (III)", i: "Tri√≥xido de dihierro", cat: "oxidos" },
            { f: "CuO", s: "√ìxido de cobre (II)", i: "Mon√≥xido de cobre", cat: "oxidos" },
            { f: "Cu2O", s: "√ìxido de cobre (I)", i: "Mon√≥xido de dicobre", cat: "oxidos" },
            { f: "ZnO", s: "√ìxido de cinc", i: "Mon√≥xido de cinc", cat: "oxidos" },
            { f: "PbO", s: "√ìxido de plomo (II)", i: "Mon√≥xido de plomo", cat: "oxidos" },
            { f: "PbO2", s: "√ìxido de plomo (IV)", i: "Di√≥xido de plomo", cat: "oxidos" },
            { f: "SO2", s: "√ìxido de azufre (IV)", i: "Di√≥xido de azufre", cat: "oxidos" },
            { f: "SO3", s: "√ìxido de azufre (VI)", i: "Tri√≥xido de azufre", cat: "oxidos" },
            { f: "CO", s: "√ìxido de carbono (II)", i: "Mon√≥xido de carbono", cat: "oxidos" },
            { f: "CO2", s: "√ìxido de carbono (IV)", i: "Di√≥xido de carbono", cat: "oxidos" },
            { f: "NO", s: "√ìxido de nitr√≥geno (II)", i: "Mon√≥xido de nitr√≥geno", cat: "oxidos" },
            { f: "N2O3", s: "√ìxido de nitr√≥geno (III)", i: "Tri√≥xido de dinitr√≥geno", cat: "oxidos" },
            { f: "NO2", s: "√ìxido de nitr√≥geno (IV)", i: "Di√≥xido de nitr√≥geno", cat: "oxidos" },
            { f: "Cl2O", s: "√ìxido de cloro (I)", i: "Mon√≥xido de dicloro", cat: "oxidos" },
            { f: "Cl2O7", s: "√ìxido de cloro (VII)", i: "Hepta√≥xido de dicloro", cat: "oxidos" },

            // PER√ìXIDOS
            { f: "H2O2", s: "Per√≥xido de hidr√≥geno", i: "Di√≥xido de dihidr√≥geno", cat: "peroxidos" },
            { f: "Na2O2", s: "Per√≥xido de sodio", i: "Di√≥xido de disodio", cat: "peroxidos" },
            { f: "K2O2", s: "Per√≥xido de potasio", i: "Di√≥xido de dipotasio", cat: "peroxidos" },
            { f: "CaO2", s: "Per√≥xido de calcio", i: "Di√≥xido de calcio", cat: "peroxidos" },
            { f: "BaO2", s: "Per√≥xido de bario", i: "Di√≥xido de bario", cat: "peroxidos" },
            { f: "MgO2", s: "Per√≥xido de magnesio", i: "Di√≥xido de magnesio", cat: "peroxidos" },

            // SALES
            { f: "NaCl", s: "Cloruro de sodio", i: "Cloruro de sodio", cat: "sales" },
            { f: "KCl", s: "Cloruro de potasio", i: "Cloruro de potasio", cat: "sales" },
            { f: "CaCl2", s: "Cloruro de calcio", i: "Dicloruro de calcio", cat: "sales" },
            { f: "FeCl2", s: "Cloruro de hierro (II)", i: "Dicloruro de hierro", cat: "sales" },
            { f: "FeCl3", s: "Cloruro de hierro (III)", i: "Tricloruro de hierro", cat: "sales" },
            { f: "AlCl3", s: "Cloruro de aluminio", i: "Tricloruro de aluminio", cat: "sales" },
            { f: "CuCl", s: "Cloruro de cobre (I)", i: "Monocloruro de cobre", cat: "sales" },
            { f: "CuCl2", s: "Cloruro de cobre (II)", i: "Dicloruro de cobre", cat: "sales" },
            { f: "AgBr", s: "Bromuro de plata", i: "Bromuro de plata", cat: "sales" },
            { f: "KI", s: "Yoduro de potasio", i: "Yoduro de potasio", cat: "sales" },
            { f: "Na2S", s: "Sulfuro de sodio", i: "Sulfuro de disodio", cat: "sales" },
            { f: "CaS", s: "Sulfuro de calcio", i: "Monosulfuro de calcio", cat: "sales" },
            { f: "FeS", s: "Sulfuro de hierro (II)", i: "Monosulfuro de hierro", cat: "sales" },
            { f: "Fe2S3", s: "Sulfuro de hierro (III)", i: "Trisulfuro de dihierro", cat: "sales" },
            { f: "ZnS", s: "Sulfuro de cinc", i: "Monosulfuro de cinc", cat: "sales" },
            { f: "PbS", s: "Sulfuro de plomo (II)", i: "Monosulfuro de plomo", cat: "sales" },
            { f: "Ag2S", s: "Sulfuro de plata", i: "Sulfuro de diplata", cat: "sales" },
            { f: "Li3N", s: "Nitruro de litio", i: "Nitruro de trilitio", cat: "sales" },
            { f: "Mg3N2", s: "Nitruro de magnesio", i: "Dinitruro de trimagnesio", cat: "sales" },
            { f: "AlN", s: "Nitruro de aluminio", i: "Mononitruro de aluminio", cat: "sales" },
            { f: "Ca3P2", s: "Fosfuro de calcio", i: "Difosfuro de tricalcio", cat: "sales" },
            { f: "PCl3", s: "(No se usa Stock)", i: "Tricloruro de f√≥sforo", cat: "sales" },
            { f: "PCl5", s: "(No se usa Stock)", i: "Pentacloruro de f√≥sforo", cat: "sales" }
        ];

        let currentCompound = {};
        let score = { correct: 0, wrong: 0 };
        let questionType = 0;
        let errorHistory = [];
        let categoryStats = {};
        let selectedCategory = 'all';

        // Elementos DOM
        const challengeElement = document.getElementById('challenge');
        const questionTypeElement = document.getElementById('question-type');
        const feedbackElement = document.getElementById('feedback');
        const inputFormula = document.getElementById('answer-formula');
        const inputStock = document.getElementById('answer-stock');
        const inputSistem = document.getElementById('answer-sistem');
        const containerStock = document.getElementById('container-stock');
        const containerSistem = document.getElementById('container-sistem');
        const containerFormula = document.getElementById('container-formula');
        const btnCheck = document.getElementById('check-button');
        const btnNext = document.getElementById('next-button');
        const btnHint = document.getElementById('hint-button');
        const categoryFilter = document.getElementById('category-filter');
        const errorHistoryDiv = document.getElementById('error-history');
        const errorList = document.getElementById('error-list');
        const statsContainer = document.getElementById('stats-container');

        // Cargar datos
        function loadData() {
            const saved = localStorage.getItem('chemistryMasterDataV2');
            if (saved) {
                const data = JSON.parse(saved);
                score = data.score || { correct: 0, wrong: 0 };
                errorHistory = data.errorHistory || [];
                categoryStats = data.categoryStats || {};
            }
            updateScore();
            updateErrorHistory();
            updateStats();
        }

        // Guardar datos
        function saveData() {
            localStorage.setItem('chemistryMasterDataV2', JSON.stringify({
                score,
                errorHistory,
                categoryStats
            }));
        }

        function normalize(text) {
            if (!text) return "";
            return text.toLowerCase().trim()
                .replace(/[\s\(\)]+/g, ' ')
                .replace(/\s+de\s+/g, 'de')
                .replace(/\s+/g, ' ')
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function updateScore() {
            document.getElementById('correct-count').textContent = score.correct;
            document.getElementById('wrong-count').textContent = score.wrong;
            document.getElementById('total-count').textContent = score.correct + score.wrong;
        }

        function updateErrorHistory() {
            if (errorHistory.length === 0) {
                errorHistoryDiv.classList.add('hidden');
                return;
            }
            errorHistoryDiv.classList.remove('hidden');
            errorList.innerHTML = errorHistory.map(err => 
                `<div class="text-xs bg-red-50 p-2 rounded border border-red-100 flex justify-between items-center">
                    <span class="font-bold text-red-700">${err.formula}</span>
                    <span class="text-gray-500 truncate ml-2 text-[10px]">${err.correct}</span>
                </div>`
            ).join('');
        }

        function addError(formula, correctAnswer) {
            errorHistory.unshift({ formula, correct: correctAnswer });
            if (errorHistory.length > 5) errorHistory.pop();
            updateErrorHistory();
            saveData();
        }

        function updateStats() {
            const categories = ['hidruros', 'oxidos', 'peroxidos', 'sales'];
            statsContainer.innerHTML = categories.map(cat => {
                const stats = categoryStats[cat] || { correct: 0, wrong: 0 };
                const total = stats.correct + stats.wrong;
                const percentage = total > 0 ? Math.round((stats.correct / total) * 100) : 0;
                // Si no hay intentos, no mostrar para limpiar UI
                if(total === 0) return '';
                
                return `<div class="flex justify-between items-center text-xs text-gray-500">
                    <span class="capitalize w-16">${cat}</span>
                    <div class="flex-grow bg-gray-200 rounded-full h-1.5 mx-2">
                        <div class="bg-secondary h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <span>${percentage}%</span>
                </div>`;
            }).join('');
        }

        function updateCategoryStats(category, isCorrect) {
            if (!categoryStats[category]) {
                categoryStats[category] = { correct: 0, wrong: 0 };
            }
            if (isCorrect) {
                categoryStats[category].correct++;
            } else {
                categoryStats[category].wrong++;
            }
            updateStats();
            saveData();
        }

        function resetInterface() {
            inputFormula.value = '';
            inputStock.value = '';
            inputSistem.value = '';
            feedbackElement.classList.add('hidden');
            feedbackElement.textContent = '';
            
            // Toggle botones
            btnCheck.classList.remove('hidden');
            btnNext.classList.add('hidden');
            btnNext.disabled = true;
            
            // Habilitar inputs
            inputFormula.disabled = false;
            inputStock.disabled = false;
            inputSistem.disabled = false;
        }

        function getFilteredCompounds() {
            if (selectedCategory === 'all') return compounds;
            return compounds.filter(c => c.cat === selectedCategory);
        }

        function generateExercise() {
            resetInterface();
            const available = getFilteredCompounds();
            if (available.length === 0) {
                alert('No hay compuestos en esta categor√≠a');
                return;
            }
            const index = Math.floor(Math.random() * available.length);
            currentCompound = available[index];
            questionType = Math.random() < 0.5 ? 0 : 1;

            if (questionType === 0) {
                // TAREA: FORMULAR
                const nameType = Math.random() < 0.5 ? 'stock' : 'sistem';
                let questionName = nameType === 'stock' ? currentCompound.s : currentCompound.i;
                if(currentCompound.s.includes("No se usa") && nameType === 'stock') {
                    questionName = currentCompound.i;
                }

                questionTypeElement.textContent = "TAREA: FORMULAR";
                challengeElement.innerHTML = `
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Escribe la f√≥rmula</div>
                    <div class="text-2xl font-black text-primary">${questionName}</div>
                `;
                
                containerFormula.classList.remove('hidden');
                containerStock.classList.add('hidden');
                containerSistem.classList.add('hidden');
                setTimeout(() => inputFormula.focus(), 100);

            } else {
                // TAREA: NOMBRAR
                questionTypeElement.textContent = "TAREA: NOMBRAR";
                const formattedFormula = currentCompound.f.replace(/(\d+)/g, '<sub>$1</sub>');
                challengeElement.innerHTML = `
                     <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Nombra el compuesto</div>
                     <div class="text-4xl font-black text-primary font-serif">${formattedFormula}</div>
                `;
                
                containerFormula.classList.add('hidden');
                
                if(currentCompound.s.includes("No se usa")) {
                    containerStock.classList.add('hidden');
                    containerSistem.classList.remove('hidden');
                } else {
                    containerStock.classList.remove('hidden');
                    containerSistem.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    if(!containerStock.classList.contains('hidden')) inputStock.focus();
                    else inputSistem.focus();
                }, 100);
            }
        }

        function showHint() {
            const categoryNames = {
                'hidruros': 'Hidruro',
                'oxidos': '√ìxido',
                'peroxidos': 'Per√≥xido',
                'sales': 'Sal Binaria'
            };
            const hint = `üí° Es un/a ${categoryNames[currentCompound.cat]}`;
            alert(hint);
        }

        function checkAnswer() {
            // Validaciones b√°sicas
            if (questionType === 0 && !inputFormula.value.trim()) return;
            if (questionType === 1) {
                if (!containerStock.classList.contains('hidden') && !inputStock.value.trim()) return;
                if (!inputSistem.value.trim()) return;
            }

            // Deshabilitar UI para evitar doble env√≠o y forzar lectura
            inputFormula.disabled = true;
            inputStock.disabled = true;
            inputSistem.disabled = true;
            
            btnCheck.classList.add('hidden');
            btnNext.classList.remove('hidden');
            btnNext.disabled = false;
            
            let isCorrect = true;
            let message = '';
            
            if (questionType === 0) {
                const userAnswer = normalize(inputFormula.value);
                const correctAnswer = normalize(currentCompound.f);

                if (userAnswer === correctAnswer) {
                    message = '‚úÖ ¬°F√≥rmula Correcta!';
                } else {
                    message = `‚ùå Incorrecto. La soluci√≥n es: <strong>${currentCompound.f}</strong>`;
                    isCorrect = false;
                    addError(currentCompound.f, `Stock: ${currentCompound.s}`);
                }
            } else {
                const userSistem = normalize(inputSistem.value);
                const correctSistem = normalize(currentCompound.i);
                
                let isStockCorrect = true;
                let stockMsg = '';

                if(!currentCompound.s.includes("No se usa")) {
                    const userStock = normalize(inputStock.value);
                    const correctStock = normalize(currentCompound.s);
                    isStockCorrect = userStock === correctStock;
                    stockMsg = isStockCorrect ? '‚úÖ Stock correcta.<br>' : `‚ùå Stock mal (Es: ${currentCompound.s})<br>`;
                } else {
                    stockMsg = '<span class="text-gray-400 text-xs">Stock no aplica</span><br>';
                }

                const isSistemCorrect = userSistem === correctSistem;
                isCorrect = isStockCorrect && isSistemCorrect;

                if (isCorrect) {
                    message = '‚úÖ ¬°Perfecto!';
                } else {
                    message = stockMsg;
                    message += isSistemCorrect ? '‚úÖ Sist. correcta.' : `‚ùå Sist. mal (Es: ${currentCompound.i})`;
                    addError(currentCompound.f, `${currentCompound.s} / ${currentCompound.i}`);
                }
            }
            
            feedbackElement.classList.remove('hidden');
            feedbackElement.classList.remove('bg-green-100', 'text-green-800', 'border-green-200', 'bg-red-100', 'text-red-800', 'border-red-200');
            
            if (isCorrect) {
                score.correct++;
                feedbackElement.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
            } else {
                score.wrong++;
                feedbackElement.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
            }

            feedbackElement.innerHTML = message;
            updateScore();
            updateCategoryStats(currentCompound.cat, isCorrect);
            saveData();
            btnNext.focus();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            generateExercise();
            
            btnCheck.addEventListener('click', checkAnswer);
            btnNext.addEventListener('click', generateExercise);
            btnHint.addEventListener('click', showHint);
            
            categoryFilter.addEventListener('change', (e) => {
                selectedCategory = e.target.value;
                generateExercise();
            });

            document.getElementById('clear-history').addEventListener('click', () => {
                if (confirm('¬øLimpiar historial?')) {
                    errorHistory = [];
                    updateErrorHistory();
                    saveData();
                }
            });

            document.getElementById('reset-stats').addEventListener('click', () => {
                if (confirm('¬øResetear todo?')) {
                    score = { correct: 0, wrong: 0 };
                    errorHistory = [];
                    categoryStats = {};
                    updateScore();
                    updateErrorHistory();
                    updateStats();
                    saveData();
                    generateExercise();
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (!btnCheck.classList.contains('hidden')) checkAnswer();
                    else if (!btnNext.classList.contains('hidden')) generateExercise();
                }
            });
        });
    </script>
</body>
</html>