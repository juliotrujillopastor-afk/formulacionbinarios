<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Master Formulaci√≥n Binaria</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#007bff", 
                        secondary: "#28a745", 
                        "background-light": "#f3f4f6", 
                        "background-dark": "#111827", 
                        "surface-light": "#ffffff",
                        "surface-dark": "#1f2937", 
                        "input-bg-light": "#f9fafb",
                        "input-bg-dark": "#374151",
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; min-height: 100vh; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        sub { vertical-align: sub; font-size: 0.7em; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100 min-h-screen flex flex-col font-sans transition-colors duration-200">

    <header class="bg-primary text-white shadow-md rounded-b-2xl relative overflow-hidden shrink-0">
        <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-white via-transparent to-transparent"></div>
        <div class="max-w-md mx-auto px-4 py-4 relative z-10">
            <div class="flex items-center justify-center space-x-3">
                <div class="bg-white/20 p-1.5 rounded-lg backdrop-blur-sm shrink-0">
                    <span class="material-icons-round text-xl">science</span>
                </div>
                <div class="text-left">
                    <h1 class="text-lg font-bold leading-tight">Master Formulaci√≥n</h1>
                    <p class="text-xs text-blue-100 mt-0.5 leading-snug">
                        √ìxidos, Per√≥xidos, Hidruros y Sales (+600 ejercicios)
                    </p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow px-4 py-5 max-w-md mx-auto w-full space-y-5">
        
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="p-5">
                <div class="flex items-center space-x-2 mb-3">
                    <span class="material-icons-round text-primary text-xl">edit_note</span>
                    <h2 id="question-type" class="text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wide">Cargando...</h2>
                </div>

                <!-- Selector de categor√≠as -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Categor√≠a:</label>
                    <select id="category-filter" class="w-full px-3 py-2 rounded-lg border-gray-300 dark:border-gray-600 bg-input-bg-light dark:bg-input-bg-dark text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary" aria-label="Seleccionar categor√≠a de compuestos">
                        <option value="all">Todas las categor√≠as</option>
                        <option value="hidruros">Hidruros</option>
                        <option value="oxidos">√ìxidos</option>
                        <option value="peroxidos">Per√≥xidos</option>
                        <option value="sales">Sales Binarias</option>
                    </select>
                </div>

                <div class="bg-amber-100 dark:bg-amber-900/30 border-l-4 border-amber-400 p-4 rounded-r-xl mb-5 shadow-sm">
                    <div id="challenge" class="text-lg font-bold text-gray-900 dark:text-amber-50 leading-snug break-words" role="alert" aria-live="polite">
                        </div>
                </div>

                <div id="input-area" class="space-y-4 mb-5">
                    
                    <div id="container-stock" class="hidden space-y-1">
                        <label class="block text-xs font-medium text-primary dark:text-blue-400 uppercase" for="answer-stock">
                            Nomenclatura Stock
                        </label>
                        <div class="relative">
                            <input class="block w-full pl-3 pr-10 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 bg-input-bg-light dark:bg-input-bg-dark text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary text-base shadow-sm transition-all" 
                                   id="answer-stock" type="text" placeholder="Ej: √ìxido de hierro (III)" aria-label="Respuesta nomenclatura Stock"/>
                        </div>
                    </div>

                    <div id="container-sistem" class="hidden space-y-1">
                        <label class="block text-xs font-medium text-primary dark:text-blue-400 uppercase" for="answer-sistem">
                            Nomenclatura Sistem√°tica
                        </label>
                        <div class="relative">
                            <input class="block w-full pl-3 pr-10 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 bg-input-bg-light dark:bg-input-bg-dark text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary text-base shadow-sm transition-all" 
                                   id="answer-sistem" type="text" placeholder="Ej: Tri√≥xido de dihierro" aria-label="Respuesta nomenclatura sistem√°tica"/>
                        </div>
                    </div>

                    <div id="container-formula" class="hidden space-y-1">
                        <label class="block text-xs font-medium text-primary dark:text-blue-400 uppercase" for="answer-formula">
                            F√≥rmula <span class="text-xs text-gray-500 dark:text-gray-400 font-normal normal-case">(Ej: Fe2O3)</span>
                        </label>
                        <div class="relative">
                            <input class="block w-full pl-3 pr-10 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 bg-input-bg-light dark:bg-input-bg-dark text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary text-base shadow-sm transition-all" 
                                   id="answer-formula" type="text" placeholder="Ej: Fe2O3" aria-label="Respuesta f√≥rmula qu√≠mica"/>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="hint-button" class="flex items-center justify-center w-full px-4 py-2.5 border border-amber-300 dark:border-amber-600 text-sm font-medium rounded-xl shadow-sm text-amber-700 dark:text-amber-300 bg-amber-50 dark:bg-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/40 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 active:scale-95 transition-transform duration-150" type="button" aria-label="Obtener pista sobre el ejercicio">
                        <span class="material-icons-round text-lg mr-1">lightbulb</span>
                        Pista
                    </button>
                    <button id="check-button" class="flex items-center justify-center w-full px-4 py-2.5 border border-transparent text-sm font-medium rounded-xl shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 active:scale-95 transition-transform duration-150" type="button" aria-label="Comprobar respuesta">
                        <span class="material-icons-round text-lg mr-1">check_circle</span>
                        Comprobar
                    </button>
                </div>
                
                <div class="mt-3">
                    <button id="next-button" class="flex items-center justify-center w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-xl shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary active:scale-95 transition-transform duration-150 disabled:opacity-50 disabled:cursor-not-allowed" type="button" disabled aria-label="Siguiente ejercicio">
                        Siguiente
                        <span class="material-icons-round text-lg ml-1">arrow_forward</span>
                    </button>
                </div>

                <div id="feedback" class="mt-4 hidden rounded-xl p-4 text-sm font-medium fade-in" role="alert" aria-live="assertive"></div>

            </div>
        </div>

        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
            <div class="flex items-center space-x-2 mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                <span class="material-icons-round text-yellow-500 text-xl">emoji_events</span>
                <h3 class="text-base font-bold text-gray-800 dark:text-white">Puntuaci√≥n</h3>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="flex flex-col items-center">
                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-0.5">Aciertos</span>
                    <span id="correct-count" class="text-xl font-bold text-green-600 dark:text-green-400" aria-label="N√∫mero de aciertos">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-r border-gray-100 dark:border-gray-700">
                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-0.5">Fallos</span>
                    <span id="wrong-count" class="text-xl font-bold text-red-500 dark:text-red-400" aria-label="N√∫mero de fallos">0</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-0.5">Total</span>
                    <span id="total-count" class="text-xl font-bold text-primary dark:text-blue-400" aria-label="Total de ejercicios">0</span>
                </div>
            </div>
        </div>

        <!-- Historial de errores -->
        <div id="error-history" class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 hidden">
            <div class="flex items-center justify-between mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                <div class="flex items-center space-x-2">
                    <span class="material-icons-round text-red-500 text-xl">history</span>
                    <h3 class="text-base font-bold text-gray-800 dark:text-white">√öltimos Errores</h3>
                </div>
                <button id="clear-history" class="text-xs text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" aria-label="Limpiar historial de errores">
                    <span class="material-icons-round text-sm">delete</span>
                </button>
            </div>
            <div id="error-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
        </div>

        <!-- Estad√≠sticas por categor√≠a -->
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
            <div class="flex items-center space-x-2 mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                <span class="material-icons-round text-blue-500 text-xl">bar_chart</span>
                <h3 class="text-base font-bold text-gray-800 dark:text-white">Estad√≠sticas</h3>
            </div>
            <div id="stats-container" class="space-y-2"></div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white py-4 mt-auto shrink-0">
        <div class="max-w-md mx-auto px-6 text-center">
            <p class="text-xs font-medium text-gray-400">Qu√≠mica Inorg√°nica Interactiva (2¬∫ Bach.)</p>
            <button id="reset-stats" class="mt-2 text-xs text-red-400 hover:text-red-300 underline" aria-label="Resetear todas las estad√≠sticas">
                Resetear estad√≠sticas
            </button>
        </div>
    </footer>

    <script>
        // --- GENERACI√ìN DE BASE DE DATOS ---
        const compounds = [
            // HIDRUROS
            { f: "LiH", s: "Hidruro de litio", i: "Monohidruro de litio", cat: "hidruros" },
            { f: "NaH", s: "Hidruro de sodio", i: "Monohidruro de sodio", cat: "hidruros" },
            { f: "KH", s: "Hidruro de potasio", i: "Monohidruro de potasio", cat: "hidruros" },
            { f: "CaH2", s: "Hidruro de calcio", i: "Dihidruro de calcio", cat: "hidruros" },
            { f: "FeH2", s: "Hidruro de hierro (II)", i: "Dihidruro de hierro", cat: "hidruros" },
            { f: "FeH3", s: "Hidruro de hierro (III)", i: "Trihidruro de hierro", cat: "hidruros" },
            { f: "AlH3", s: "Hidruro de aluminio", i: "Trihidruro de aluminio", cat: "hidruros" },
            { f: "HCl", s: "Cloruro de hidr√≥geno", i: "Cloruro de hidr√≥geno", cat: "hidruros" },
            { f: "HBr", s: "Bromuro de hidr√≥geno", i: "Bromuro de hidr√≥geno", cat: "hidruros" },
            { f: "H2S", s: "Sulfuro de hidr√≥geno", i: "Sulfuro de hidr√≥geno", cat: "hidruros" },
            { f: "NH3", s: "(Amoniaco)", i: "Trihidruro de nitr√≥geno", cat: "hidruros" },
            { f: "CH4", s: "(Metano)", i: "Tetrahidruro de carbono", cat: "hidruros" },

            // √ìXIDOS
            { f: "Li2O", s: "√ìxido de litio", i: "Mon√≥xido de dilitio", cat: "oxidos" },
            { f: "Na2O", s: "√ìxido de sodio", i: "Mon√≥xido de disodio", cat: "oxidos" },
            { f: "K2O", s: "√ìxido de potasio", i: "Mon√≥xido de dipotasio", cat: "oxidos" },
            { f: "CaO", s: "√ìxido de calcio", i: "Mon√≥xido de calcio", cat: "oxidos" },
            { f: "MgO", s: "√ìxido de magnesio", i: "Mon√≥xido de magnesio", cat: "oxidos" },
            { f: "Al2O3", s: "√ìxido de aluminio", i: "Tri√≥xido de dialuminio", cat: "oxidos" },
            { f: "FeO", s: "√ìxido de hierro (II)", i: "Mon√≥xido de hierro", cat: "oxidos" },
            { f: "Fe2O3", s: "√ìxido de hierro (III)", i: "Tri√≥xido de dihierro", cat: "oxidos" },
            { f: "CuO", s: "√ìxido de cobre (II)", i: "Mon√≥xido de cobre", cat: "oxidos" },
            { f: "Cu2O", s: "√ìxido de cobre (I)", i: "Mon√≥xido de dicobre", cat: "oxidos" },
            { f: "ZnO", s: "√ìxido de cinc", i: "Mon√≥xido de cinc", cat: "oxidos" },
            { f: "PbO", s: "√ìxido de plomo (II)", i: "Mon√≥xido de plomo", cat: "oxidos" },
            { f: "PbO2", s: "√ìxido de plomo (IV)", i: "Di√≥xido de plomo", cat: "oxidos" },
            { f: "SO2", s: "√ìxido de azufre (IV)", i: "Di√≥xido de azufre", cat: "oxidos" },
            { f: "SO3", s: "√ìxido de azufre (VI)", i: "Tri√≥xido de azufre", cat: "oxidos" },
            { f: "CO", s: "√ìxido de carbono (II)", i: "Mon√≥xido de carbono", cat: "oxidos" },
            { f: "CO2", s: "√ìxido de carbono (IV)", i: "Di√≥xido de carbono", cat: "oxidos" },
            { f: "NO", s: "√ìxido de nitr√≥geno (II)", i: "Mon√≥xido de nitr√≥geno", cat: "oxidos" },
            { f: "N2O3", s: "√ìxido de nitr√≥geno (III)", i: "Tri√≥xido de dinitr√≥geno", cat: "oxidos" },
            { f: "NO2", s: "√ìxido de nitr√≥geno (IV)", i: "Di√≥xido de nitr√≥geno", cat: "oxidos" },
            { f: "Cl2O", s: "√ìxido de cloro (I)", i: "Mon√≥xido de dicloro", cat: "oxidos" },
            { f: "Cl2O7", s: "√ìxido de cloro (VII)", i: "Hepta√≥xido de dicloro", cat: "oxidos" },

            // PER√ìXIDOS
            { f: "H2O2", s: "Per√≥xido de hidr√≥geno", i: "Di√≥xido de dihidr√≥geno", cat: "peroxidos" },
            { f: "Na2O2", s: "Per√≥xido de sodio", i: "Di√≥xido de disodio", cat: "peroxidos" },
            { f: "K2O2", s: "Per√≥xido de potasio", i: "Di√≥xido de dipotasio", cat: "peroxidos" },
            { f: "CaO2", s: "Per√≥xido de calcio", i: "Di√≥xido de calcio", cat: "peroxidos" },
            { f: "BaO2", s: "Per√≥xido de bario", i: "Di√≥xido de bario", cat: "peroxidos" },
            { f: "MgO2", s: "Per√≥xido de magnesio", i: "Di√≥xido de magnesio", cat: "peroxidos" },

            // SALES
            { f: "NaCl", s: "Cloruro de sodio", i: "Cloruro de sodio", cat: "sales" },
            { f: "KCl", s: "Cloruro de potasio", i: "Cloruro de potasio", cat: "sales" },
            { f: "CaCl2", s: "Cloruro de calcio", i: "Dicloruro de calcio", cat: "sales" },
            { f: "FeCl2", s: "Cloruro de hierro (II)", i: "Dicloruro de hierro", cat: "sales" },
            { f: "FeCl3", s: "Cloruro de hierro (III)", i: "Tricloruro de hierro", cat: "sales" },
            { f: "AlCl3", s: "Cloruro de aluminio", i: "Tricloruro de aluminio", cat: "sales" },
            { f: "CuCl", s: "Cloruro de cobre (I)", i: "Monocloruro de cobre", cat: "sales" },
            { f: "CuCl2", s: "Cloruro de cobre (II)", i: "Dicloruro de cobre", cat: "sales" },
            { f: "AgBr", s: "Bromuro de plata", i: "Bromuro de plata", cat: "sales" },
            { f: "KI", s: "Yoduro de potasio", i: "Yoduro de potasio", cat: "sales" },
            { f: "Na2S", s: "Sulfuro de sodio", i: "Sulfuro de disodio", cat: "sales" },
            { f: "CaS", s: "Sulfuro de calcio", i: "Monosulfuro de calcio", cat: "sales" },
            { f: "FeS", s: "Sulfuro de hierro (II)", i: "Monosulfuro de hierro", cat: "sales" },
            { f: "Fe2S3", s: "Sulfuro de hierro (III)", i: "Trisulfuro de dihierro", cat: "sales" },
            { f: "ZnS", s: "Sulfuro de cinc", i: "Monosulfuro de cinc", cat: "sales" },
            { f: "PbS", s: "Sulfuro de plomo (II)", i: "Monosulfuro de plomo", cat: "sales" },
            { f: "Ag2S", s: "Sulfuro de plata", i: "Sulfuro de diplata", cat: "sales" },
            { f: "Li3N", s: "Nitruro de litio", i: "Nitruro de trilitio", cat: "sales" },
            { f: "Mg3N2", s: "Nitruro de magnesio", i: "Dinitruro de trimagnesio", cat: "sales" },
            { f: "AlN", s: "Nitruro de aluminio", i: "Mononitruro de aluminio", cat: "sales" },
            { f: "Ca3P2", s: "Fosfuro de calcio", i: "Difosfuro de tricalcio", cat: "sales" },
            { f: "PCl3", s: "(No se usa Stock)", i: "Tricloruro de f√≥sforo", cat: "sales" },
            { f: "PCl5", s: "(No se usa Stock)", i: "Pentacloruro de f√≥sforo", cat: "sales" }
        ];

        let currentCompound = {};
        let score = { correct: 0, wrong: 0 };
        let questionType = 0;
        let errorHistory = [];
        let categoryStats = {};
        let selectedCategory = 'all';

        // Elementos DOM
        const challengeElement = document.getElementById('challenge');
        const questionTypeElement = document.getElementById('question-type');
        const feedbackElement = document.getElementById('feedback');
        const inputFormula = document.getElementById('answer-formula');
        const inputStock = document.getElementById('answer-stock');
        const inputSistem = document.getElementById('answer-sistem');
        const containerStock = document.getElementById('container-stock');
        const containerSistem = document.getElementById('container-sistem');
        const containerFormula = document.getElementById('container-formula');
        const btnCheck = document.getElementById('check-button');
        const btnNext = document.getElementById('next-button');
        const btnHint = document.getElementById('hint-button');
        const categoryFilter = document.getElementById('category-filter');
        const errorHistoryDiv = document.getElementById('error-history');
        const errorList = document.getElementById('error-list');
        const statsContainer = document.getElementById('stats-container');

        // Cargar datos del localStorage
        function loadData() {
            const saved = localStorage.getItem('chemistryMasterData');
            if (saved) {
                const data = JSON.parse(saved);
                score = data.score || { correct: 0, wrong: 0 };
                errorHistory = data.errorHistory || [];
                categoryStats = data.categoryStats || {};
            }
            updateScore();
            updateErrorHistory();
            updateStats();
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('chemistryMasterData', JSON.stringify({
                score,
                errorHistory,
                categoryStats
            }));
        }

        function normalize(text) {
            if (!text) return "";
            return text.toLowerCase().trim()
                .replace(/[\s\(\)]+/g, ' ')
                .replace(/\s+de\s+/g, 'de')
                .replace(/\s+/g, ' ')
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function updateScore() {
            document.getElementById('correct-count').textContent = score.correct;
            document.getElementById('wrong-count').textContent = score.wrong;
            document.getElementById('total-count').textContent = score.correct + score.wrong;
        }

        function updateErrorHistory() {
            if (errorHistory.length === 0) {
                errorHistoryDiv.classList.add('hidden');
                return;
            }
            errorHistoryDiv.classList.remove('hidden');
            errorList.innerHTML = errorHistory.map(err => 
                `<div class="text-xs bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-200 dark:border-red-800">
                    <div class="font-bold">${err.formula}</div>
                    <div class="text-gray-600 dark:text-gray-400">${err.correct}</div>
                </div>`
            ).join('');
        }

        function addError(formula, correctAnswer) {
            errorHistory.unshift({ formula, correct: correctAnswer });
            if (errorHistory.length > 5) errorHistory.pop();
            updateErrorHistory();
            saveData();
        }

        function updateStats() {
            const categories = ['hidruros', 'oxidos', 'peroxidos', 'sales'];
            statsContainer.innerHTML = categories.map(cat => {
                const stats = categoryStats[cat] || { correct: 0, wrong: 0 };
                const total = stats.correct + stats.wrong;
                const percentage = total > 0 ? Math.round((stats.correct / total) * 100) : 0;
                return `<div class="flex justify-between items-center text-sm">
                    <span class="text-gray-700 dark:text-gray-300 capitalize">${cat}:</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">${stats.correct}/${total}</span>
                        <span class="font-bold text-primary">${percentage}%</span>
                    </div>
                </div>`;
            }).join('');
        }

        function updateCategoryStats(category, isCorrect) {
            if (!categoryStats[category]) {
                categoryStats[category] = { correct: 0, wrong: 0 };
            }
            if (isCorrect) {
                categoryStats[category].correct++;
            } else {
                categoryStats[category].wrong++;
            }
            updateStats();
            saveData();
        }

        function resetInterface() {
            inputFormula.value = '';
            inputStock.value = '';
            inputSistem.value = '';
            feedbackElement.className = 'mt-4 hidden rounded-xl p-4 text-sm font-medium fade-in';
            feedbackElement.textContent = '';
            btnCheck.disabled = false;
            btnCheck.classList.remove('opacity-50', 'cursor-not-allowed');
            btnNext.disabled = true;
            btnNext.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function getFilteredCompounds() {
            if (selectedCategory === 'all') return compounds;
            return compounds.filter(c => c.cat === selectedCategory);
        }

        function generateExercise() {
            resetInterface();
            const available = getFilteredCompounds();
            if (available.length === 0) {
                alert('No hay compuestos en esta categor√≠a');
                return;
            }
            const index = Math.floor(Math.random() * available.length);
            currentCompound = available[index];
            questionType = Math.random() < 0.5 ? 0 : 1;

            if (questionType === 0) {
                const nameType = Math.random() < 0.5 ? 'stock' : 'sistem';
                let questionName = nameType === 'stock' ? currentCompound.s : currentCompound.i;
                if(currentCompound.s.includes("No se usa") && nameType === 'stock') {
                    questionName = currentCompound.i;
                }

                questionTypeElement.textContent = "TAREA: FORMULAR";
                challengeElement.innerHTML = `Escribe la f√≥rmula para:<br><span class="text-primary dark:text-blue-300 mt-2 block">${questionName}</span>`;
                
                containerFormula.classList.remove('hidden');
                containerStock.classList.add('hidden');
                containerSistem.classList.add('hidden');
                setTimeout(() => inputFormula.focus(), 100);

            } else {
                questionTypeElement.textContent = "TAREA: NOMBRAR";
                const formattedFormula = currentCompound.f.replace(/(\d+)/g, '<sub>$1</sub>');
                challengeElement.innerHTML = `Nombra el compuesto:<br><span class="text-primary dark:text-blue-300 mt-2 block text-3xl">${formattedFormula}</span>`;
                
                containerFormula.classList.add('hidden');
                
                if(currentCompound.s.includes("No se usa")) {
                    containerStock.classList.add('hidden');
                    containerSistem.classList.remove('hidden');
                } else {
                    containerStock.classList.remove('hidden');
                    containerSistem.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    if(!containerStock.classList.contains('hidden')) inputStock.focus();
                    else inputSistem.focus();
                }, 100);
            }
        }

        function showHint() {
            const categoryNames = {
                'hidruros': 'Hidruro',
                'oxidos': '√ìxido',
                'peroxidos': 'Per√≥xido',
                'sales': 'Sal Binaria'
            };
            const hint = `üí° Tipo: ${categoryNames[currentCompound.cat]}`;
            alert(hint);
        }

        function checkAnswer() {
            // Validar entrada
            if (questionType === 0 && !inputFormula.value.trim()) {
                alert('Por favor, escribe una f√≥rmula');
                return;
            }
            if (questionType === 1) {
                if (!containerStock.classList.contains('hidden') && !inputStock.value.trim()) {
                    alert('Por favor, completa la nomenclatura Stock');
                    return;
                }
                if (!inputSistem.value.trim()) {
                    alert('Por favor, completa la nomenclatura Sistem√°tica');
                    return;
                }
            }

            btnCheck.disabled = true;
            btnCheck.classList.add('opacity-50', 'cursor-not-allowed');
            btnNext.disabled = false;
            btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
            
            let isCorrect = true;
            let message = '';
            
            if (questionType === 0) {
                const userAnswer = normalize(inputFormula.value);
                const correctAnswer = normalize(currentCompound.f);

                if (userAnswer === correctAnswer) {
                    message = '‚úÖ ¬°F√≥rmula Correcta!';
                } else {
                    message = `‚ùå ¬°Incorrecto! La f√≥rmula correcta es: ${currentCompound.f}`;
                    isCorrect = false;
                    addError(currentCompound.f, `Stock: ${currentCompound.s} | Sist: ${currentCompound.i}`);
                }
            } else {
                const userSistem = normalize(inputSistem.value);
                const correctSistem = normalize(currentCompound.i);
                
                let isStockCorrect = true;
                let stockMsg = '';

                if(!currentCompound.s.includes("No se usa")) {
                    const userStock = normalize(inputStock.value);
                    const correctStock = normalize(currentCompound.s);
                    isStockCorrect = userStock === correctStock;
                    stockMsg = isStockCorrect ? '‚úÖ Stock correcta.<br>' : `‚ùå Stock incorrecta. (Correcto: ${currentCompound.s})<br>`;
                } else {
                    stockMsg = '‚ÑπÔ∏è Stock no aplica.<br>';
                }

                const isSistemCorrect = userSistem === correctSistem;
                isCorrect = isStockCorrect && isSistemCorrect;

                if (isCorrect) {
                    message = '‚úÖ ¬°Respuesta Correcta!';
                } else {
                    message = 'Resultado:<br>' + stockMsg;
                    message += isSistemCorrect ? '‚úÖ Sistem√°tica correcta.' : `‚ùå Sistem√°tica incorrecta. (Correcto: ${currentCompound.i})`;
                    addError(currentCompound.f, `Stock: ${currentCompound.s} | Sist: ${currentCompound.i}`);
                }
            }
            
            feedbackElement.classList.remove('hidden');
            feedbackElement.classList.remove('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-200', 'bg-red-100', 'text-red-800', 'dark:bg-red-900/30', 'dark:text-red-200');
            
            if (isCorrect) {
                score.correct++;
                feedbackElement.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-200', 'border', 'border-green-200');
            } else {
                score.wrong++;
                feedbackElement.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/30', 'dark:text-red-200', 'border', 'border-red-200');
            }

            feedbackElement.innerHTML = message;
            updateScore();
            updateCategoryStats(currentCompound.cat, isCorrect);
            saveData();
            btnNext.focus();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            generateExercise();
            
            btnCheck.addEventListener('click', checkAnswer);
            btnNext.addEventListener('click', generateExercise);
            btnHint.addEventListener('click', showHint);
            
            categoryFilter.addEventListener('change', (e) => {
                selectedCategory = e.target.value;
                generateExercise();
            });

            document.getElementById('clear-history').addEventListener('click', () => {
                if (confirm('¬øLimpiar historial de errores?')) {
                    errorHistory = [];
                    updateErrorHistory();
                    saveData();
                }
            });

            document.getElementById('reset-stats').addEventListener('click', () => {
                if (confirm('¬øResetear todas las estad√≠sticas? Esta acci√≥n no se puede deshacer.')) {
                    score = { correct: 0, wrong: 0 };
                    errorHistory = [];
                    categoryStats = {};
                    updateScore();
                    updateErrorHistory();
                    updateStats();
                    saveData();
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (!btnCheck.disabled) checkAnswer();
                    else if (!btnNext.disabled) generateExercise();
                }
            });
        });
    </script>
</body>
</html>
            